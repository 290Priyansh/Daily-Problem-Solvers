<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>String Art Portrait Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"></script>
    <style>
        @import url('https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css');
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        
        .file-input::before {
            content: 'Choose File';
            color: #4f46e5;
            display: inline-block;
            background: #f0f9ff;
            border: 1px solid #e0e7ff;
            border-radius: 20px;
            padding: 8px 16px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        
        .file-input:hover::before {
            background: #e0f2fe;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 font-sans text-gray-800">
    <!-- Header -->
    <div class="flex flex-col items-center p-4">
        <h1 class="text-4xl font-extrabold text-indigo-700 mb-8 mt-4 rounded-lg p-3 shadow-lg bg-white">
            String Art Portrait Generator
        </h1>

        <!-- Upload Section -->
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl mb-8 border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-indigo-600 mb-4">Upload Your Portrait Image</h2>
            <label for="image-upload" class="block text-gray-700 text-sm font-bold mb-2">
                Choose a portrait image to generate string art:
            </label>
            <input
                type="file"
                id="image-upload"
                accept="image/*"
                class="file-input block w-full text-sm text-gray-900 cursor-pointer"
            />
            
            <div id="image-preview" class="mt-6 hidden border-2 border-gray-200 rounded-lg overflow-hidden shadow-inner">
                <img id="preview-img" src="" alt="Image Preview" class="max-w-full h-auto mx-auto rounded-md" />
            </div>
            
            <button
                id="generate-btn"
                disabled
                class="mt-8 w-full py-3 px-6 rounded-full text-lg font-bold bg-indigo-300 text-indigo-100 cursor-not-allowed transition-all duration-300"
            >
                Generate String Art Pattern
            </button>
            
            <p id="error-message" class="text-red-600 mt-4 text-center font-medium hidden"></p>
            
            <!-- Loading indicator with progress bar -->
            <div id="loading" class="hidden mt-6">
                <div class="text-center mb-4">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                    <p class="mt-2 text-indigo-600 font-semibold" id="loading-text">Preparing image...</p>
                </div>
                
                <!-- Progress Bar -->
                <div class="w-full bg-gray-200 rounded-full h-4 mb-2">
                    <div id="progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-600 h-4 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                </div>
                
                <div class="flex justify-between text-sm text-gray-600">
                    <span id="progress-text">0%</span>
                    <span id="time-estimate">Estimated time: 3-4 minutes</span>
                </div>
                
                <!-- Progress Details -->
                <div class="mt-3 text-center">
                    <p class="text-sm text-gray-500">
                        <span id="current-step">Step 1/3:</span> 
                        <span id="step-description">Processing your image...</span>
                    </p>
                    <p class="text-xs text-gray-400 mt-1" id="lines-generated">Lines generated: 0 / 8000</p>
                </div>
            </div>
        </div>

        <!-- String Art Canvas Display Section -->
        <div id="result-section" class="hidden bg-white p-8 rounded-xl shadow-2xl w-full max-w-2xl border-t-4 border-green-500 animate-fade-in">
            <h2 class="text-2xl font-semibold text-green-700 mb-4 text-center">Generated String Art Pattern</h2>
            <div class="flex justify-center">
                <canvas
                    id="string-art-canvas"
                    class="border-2 border-gray-300 rounded-lg shadow-md bg-white"
                    style="max-width: 500px; width: 100%; height: auto; aspect-ratio: 1 / 1;"
                    width="500"
                    height="500"
                ></canvas>
            </div>
            
            <p id="result-message" class="mt-4 text-gray-700 text-center italic"></p>
            
            <div class="mt-6 text-center">
                <h3 class="text-xl font-semibold text-indigo-600 mb-2">How to Recreate This:</h3>
                <p class="text-gray-700 mb-2">
                    The pattern above shows the connections. You'll need to:
                </p>
                <ol class="list-decimal list-inside text-left text-gray-700 space-y-2 max-w-lg mx-auto">
                    <li>Prepare a wooden board (e.g., 12x12 inches or 30x30 cm).</li>
                    <li>Mark the nail positions precisely using the coordinates (scaled to your board size).</li>
                    <li>Hammer the nails into the board at these marked positions.</li>
                    <li>Using a single continuous string, follow the paths, connecting the nails in the specified order.</li>
                    <li>Experiment with string thickness and tension to achieve desired visual effects.</li>
                </ol>
                <p class="mt-4 text-gray-600 text-sm">
                    *This is a visual representation. The actual number of nails and lines for a physical piece will depend on the desired detail and board size.*
                </p>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const BACKEND_API_URL = 'http://127.0.0.1:5000/api/generate-string-art';
        
        // DOM elements
        const imageUpload = document.getElementById('image-upload');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const generateBtn = document.getElementById('generate-btn');
        const errorMessage = document.getElementById('error-message');
        const loading = document.getElementById('loading');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const timeEstimate = document.getElementById('time-estimate');
        const loadingText = document.getElementById('loading-text');
        const currentStep = document.getElementById('current-step');
        const stepDescription = document.getElementById('step-description');
        const linesGenerated = document.getElementById('lines-generated');
        const resultSection = document.getElementById('result-section');
        const canvas = document.getElementById('string-art-canvas');
        const resultMessage = document.getElementById('result-message');
        
        let selectedFile = null;
        let stringArtData = null;
        
        // Handle image selection
        imageUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                selectedFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                
                // Enable generate button
                generateBtn.disabled = false;
                generateBtn.className = 'mt-8 w-full py-3 px-6 rounded-full text-lg font-bold bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg transform hover:scale-105 transition-all duration-300 cursor-pointer';
                generateBtn.textContent = 'Generate String Art Pattern';
                
                // Hide previous results and errors
                resultSection.classList.add('hidden');
                hideError();
            } else {
                selectedFile = null;
                imagePreview.classList.add('hidden');
                generateBtn.disabled = true;
                generateBtn.className = 'mt-8 w-full py-3 px-6 rounded-full text-lg font-bold bg-indigo-300 text-indigo-100 cursor-not-allowed transition-all duration-300';
            }
        });
        
        // Convert file to base64
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }
        
        // Update progress bar
        function updateProgress(percentage, step, stepDesc, linesCount = null, timeLeft = null) {
            progressBar.style.width = percentage + '%';
            progressText.textContent = Math.round(percentage) + '%';
            currentStep.textContent = step;
            stepDescription.textContent = stepDesc;
            
            if (linesCount !== null) {
                linesGenerated.textContent = `Lines generated: ${linesCount} / 8000`;
            }
            
            if (timeLeft !== null) {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timeEstimate.textContent = `Time remaining: ~${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        // Simulate progress for long-running process
        function simulateProgress() {
            let progress = 0;
            let startTime = Date.now();
            let estimatedTotalTime = 4 * 60 * 1000; // 4 minutes in milliseconds
            
            const progressInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const expectedProgress = (elapsed / estimatedTotalTime) * 100;
                
                // Smooth progress update - don't jump too quickly
                if (progress < expectedProgress) {
                    progress = Math.min(expectedProgress, progress + 1);
                }
                
                // Update progress based on stage
                if (progress < 5) {
                    updateProgress(progress, 'Step 1/3:', 'Processing your image...', null, Math.round((estimatedTotalTime - elapsed) / 1000));
                    loadingText.textContent = 'Analyzing image features...';
                } else if (progress < 10) {
                    updateProgress(progress, 'Step 2/3:', 'Generating nail positions...', null, Math.round((estimatedTotalTime - elapsed) / 1000));
                    loadingText.textContent = 'Placing nails around perimeter...';
                } else if (progress < 95) {
                    const estimatedLines = Math.floor((progress - 10) / 85 * 8000);
                    updateProgress(progress, 'Step 3/3:', 'Generating string connections...', estimatedLines, Math.round((estimatedTotalTime - elapsed) / 1000));
                    loadingText.textContent = 'Finding optimal string paths...';
                } else {
                    updateProgress(progress, 'Step 3/3:', 'Finalizing pattern...', null, Math.round((estimatedTotalTime - elapsed) / 1000));
                    loadingText.textContent = 'Almost done...';
                }
                
                // Stop at 95% and wait for actual completion
                if (progress >= 95) {
                    clearInterval(progressInterval);
                }
            }, 200); // Update every 200ms
            
            return progressInterval;
        }
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }
        
        // Hide error message
        function hideError() {
            errorMessage.classList.add('hidden');
        }
        
        // Draw string art on canvas
        function drawStringArt(data) {
            const ctx = canvas.getContext('2d');
            const canvasSize = 500;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#f8f8f8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw nails (small dots)
            ctx.fillStyle = '#333';
            data.nails.forEach(nail => {
                ctx.beginPath();
                ctx.arc(nail.x, nail.y, 1, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Draw string paths
            ctx.strokeStyle = 'rgba(51, 51, 51, 0.8)';
            ctx.lineWidth = 0.5;
            
            data.paths.forEach(path => {
                const startNail = data.nails[path.startIndex];
                const endNail = data.nails[path.endIndex];
                
                if (startNail && endNail) {
                    ctx.beginPath();
                    ctx.moveTo(startNail.x, startNail.y);
                    ctx.lineTo(endNail.x, endNail.y);
                    ctx.stroke();
                }
            });
        }
        
        // Generate string art
        async function generateStringArt() {
            if (!selectedFile) {
                showError('Please select an image first.');
                return;
            }
            
            // Show loading state
            loading.classList.remove('hidden');
            generateBtn.disabled = true;
            generateBtn.className = 'mt-8 w-full py-3 px-6 rounded-full text-lg font-bold bg-indigo-300 text-indigo-100 cursor-not-allowed transition-all duration-300';
            hideError();
            resultSection.classList.add('hidden');
            
            // Start progress simulation
            const progressInterval = simulateProgress();
            
            try {
                // Convert image to base64
                const base64ImageData = await getBase64(selectedFile);
                
                const payload = {
                    base64Image: base64ImageData,
                    mimeType: selectedFile.type,
                };
                
                // Make API call
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Backend API error: ${errorData.error || response.statusText}`);
                }
                
                const result = await response.json();
                stringArtData = result;
                
                // Complete the progress bar
                clearInterval(progressInterval);
                updateProgress(100, 'Complete!', 'String art pattern generated successfully!', result.paths.length);
                loadingText.textContent = 'Processing complete!';
                
                // Small delay to show completion
                setTimeout(() => {
                    // Draw the result
                    drawStringArt(result);
                    
                    // Show result section
                    if (result.message) {
                        resultMessage.textContent = result.message;
                    }
                    resultSection.classList.remove('hidden');
                    
                    // Hide loading
                    loading.classList.add('hidden');
                    generateBtn.disabled = false;
                    generateBtn.className = 'mt-8 w-full py-3 px-6 rounded-full text-lg font-bold bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg transform hover:scale-105 transition-all duration-300 cursor-pointer';
                }, 1000);
                
            } catch (error) {
                console.error('Error generating string art:', error);
                clearInterval(progressInterval);
                showError(`Failed to generate string art: ${error.message}`);
                
                // Hide loading state
                loading.classList.add('hidden');
                generateBtn.disabled = false;
                generateBtn.className = 'mt-8 w-full py-3 px-6 rounded-full text-lg font-bold bg-indigo-600 hover:bg-indigo-700 text-white shadow-lg transform hover:scale-105 transition-all duration-300 cursor-pointer';
            }
        }
        
        // Add event listener to generate button
        generateBtn.addEventListener('click', generateStringArt);
    </script>
</body>
</html>